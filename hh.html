<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Media Player</title>
  <meta name="theme-color" content="#0f0f10" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root{
      --bg:#0f0f10;
      --surface:#18181b;
      --surface2:#202024;
      --line:rgba(255,255,255,.08);
      --text:#fff;
      --muted:rgba(255,255,255,.65);
      --dim:rgba(255,255,255,.45);
      --accent:#ff8800;

      --appbar:56px;
      --bottomnav:56px;
      --mini:76px;

      /* background tuning */
      --bg-contrast: 1.05;
      --bg-sat: 1.15;

      /* mini player glass */
      --mini-alpha: .40;
      --mini-border-alpha: .18;
      --mini-blur: 14px;

      /* ✅ full player sheet glass */
      --fp-alpha: .42;
      --fp-border-alpha: .16;
      --fp-blur: 18px;
    }

    body[data-theme="light"]{
      --bg:#f5f5f7;
      --surface:#ffffff;
      --surface2:#f0f1f4;
      --line:rgba(0,0,0,.08);
      --text:#111;
      --muted:rgba(0,0,0,.62);
      --dim:rgba(0,0,0,.42);
      --accent:#ff8800;

      --mini-alpha: .55;
      --mini-border-alpha: .16;

      --fp-alpha: .62;
      --fp-border-alpha: .12;
    }

    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family: Roboto, system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      overflow:hidden;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
      position:relative;
    }

    /* ===== BACKGROUND LAYERS ===== */
    .bg-layer, .bg-overlay{
      position:fixed; inset:0;
      z-index:0;
      pointer-events:none;
      opacity:0;
      transition: opacity .25s ease;
    }
    .bg-layer{
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
      transform: translateZ(0);
      filter: saturate(var(--bg-sat)) contrast(var(--bg-contrast));
    }
    .bg-overlay{
      background: linear-gradient(
        to bottom,
        rgba(15,15,16,.18),
        rgba(15,15,16,.52)
      );
    }
    body[data-theme="light"] .bg-overlay{
      background: linear-gradient(
        to bottom,
        rgba(245,245,247,.14),
        rgba(245,245,247,.42)
      );
    }
    body.has-bg .bg-layer{ opacity:.58; }     /* ✅ lebih kelihatan */
    body.has-bg .bg-overlay{ opacity:1; }

    /* ===== APP BAR ===== */
    .appbar{
      position:fixed; left:0; right:0; top:0;
      height: calc(var(--appbar) + env(safe-area-inset-top));
      padding-top: env(safe-area-inset-top);
      background: color-mix(in srgb, var(--bg) 88%, transparent);
      border-bottom: 1px solid var(--line);
      z-index:50;
      display:flex;
      align-items:center;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    .appbar .inner{
      width:100%;
      max-width:1100px;
      margin:0 auto;
      padding:0 14px;
      height: var(--appbar);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .title{
      font-weight:900;
      letter-spacing:.2px;
      font-size:16px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .icon-btn{
      width:44px;height:44px;border-radius:16px;
      border:1px solid var(--line);
      background: color-mix(in srgb, var(--surface) 62%, transparent);
      color: var(--text);
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    /* ===== MAIN ===== */
    main{
      position:relative;
      z-index:1;
      height:100%;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding-top: calc(var(--appbar) + env(safe-area-inset-top) + 10px);
      padding-bottom: calc(var(--bottomnav) + var(--mini) + env(safe-area-inset-bottom) + 24px);
    }
    .container{max-width:1100px;margin:0 auto;padding:0 14px 14px}
    .hidden{display:none!important}

    /* ===== SEARCH ===== */
    .searchbox{
      display:flex; gap:10px; align-items:center;
      background: color-mix(in srgb, var(--surface) 62%, transparent);
      border:1px solid var(--line);
      border-radius: 999px;
      padding: 10px 12px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .searchbox i{color:var(--dim)}
    .searchbox input{
      flex:1;
      background:transparent;
      border:none;
      outline:none;
      color:var(--text);
      font-size:14px;
      min-width:0;
    }
    .btn-search{
      width:42px;height:42px;border-radius:16px;
      border:none; background:var(--accent); color:#111;
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
    }
    .section-label{
      margin: 12px 2px 10px;
      font-size: 12px;
      color: var(--dim);
      letter-spacing: .8px;
      text-transform: uppercase;
    }

    /* ===== LIST ===== */
    .song-list{list-style:none}
    .song-item{
      display:flex; align-items:center; gap:12px;
      padding:10px;
      border-radius: 16px;
      cursor:pointer;
      border:1px solid transparent;
      transition: background .12s ease, border-color .12s ease;
      content-visibility: auto;
      contain-intrinsic-size: 72px;
    }
    .song-item:hover{
      background: color-mix(in srgb, var(--text) 6%, transparent);
      border-color: color-mix(in srgb, var(--text) 8%, transparent)
    }
    .song-item img{
      width:46px;height:46px;border-radius:14px;
      object-fit:cover; background:color-mix(in srgb, var(--text) 8%, transparent);
      flex:0 0 auto;
    }
    .song-info{flex:1; min-width:0}
    .song-title{font-weight:800;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .song-artist{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .song-item.active-selection{
      background: color-mix(in srgb, var(--accent) 16%, transparent);
      border-color: color-mix(in srgb, var(--accent) 30%, transparent);
    }
    .song-item.active-selection .song-title{color: var(--accent)}
    .empty-msg{margin:34px 0;color:var(--dim);text-align:center;font-size:13px}

    .action-btn{
      border:none; cursor:pointer;
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 12px;
      font-weight: 900;
      transition:.12s ease;
    }
    .btn-add{
      background: color-mix(in srgb, var(--text) 6%, transparent);
      border:1px solid var(--line);
      color: var(--text);
    }
    .btn-add:hover{background: color-mix(in srgb, var(--text) 10%, transparent)}
    .btn-remove{
      background: transparent;
      color:#ff4d6d;
      padding:8px 10px;
      opacity:.9;
    }

    /* ===== PLAYLIST ===== */
    .section-header{
      display:flex; justify-content:space-between; align-items:center;
      gap:12px; margin:10px 2px 12px;
    }
    .section-header h2{font-size:18px;font-weight:900}
    .btn-primary{
      background: var(--accent);
      border:none;color:#111;
      padding:10px 14px;border-radius:16px;
      font-weight:900;cursor:pointer;
      display:flex;align-items:center;gap:8px;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap:12px;
    }
    .playlist-card{
      background: color-mix(in srgb, var(--surface) 58%, transparent);
      border:1px solid var(--line);
      border-radius: 18px;
      padding: 12px;
      cursor:pointer;
      position:relative;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .cover-art{
      width:100%; aspect-ratio: 1/1;
      border-radius: 14px;
      overflow:hidden;
      background: color-mix(in srgb, var(--text) 8%, transparent);
      margin-bottom:10px;
    }
    .cover-art img{width:100%;height:100%;object-fit:cover}
    .playlist-name{font-weight:900;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .playlist-desc{font-size:12px;color:var(--muted);margin-top:2px}
    .delete-btn{
      position:absolute; top:10px; right:10px;
      width:34px;height:34px;border-radius:14px;
      border:1px solid var(--line);
      background: color-mix(in srgb, #000 18%, transparent);
      color:var(--text); cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .pl-detail-top{
      display:flex; justify-content:space-between; align-items:center;
      gap:10px; margin: 6px 2px 12px;
    }
    .btn-ghost{
      background: color-mix(in srgb, var(--text) 6%, transparent);
      border:1px solid var(--line);
      color: var(--text);
      border-radius:16px;
      padding:10px 12px;
      cursor:pointer;
      display:flex; align-items:center; gap:10px;
      font-weight:900;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .btn-play-icon{
      width:46px;height:46px;border-radius:16px;
      background: var(--accent);
      border:none;color:#111; cursor:pointer;
      display:flex; align-items:center; justify-content:center;
    }

    /* ===== ✅ MINI PLAYER TRANSPARENT GLASS ===== */
    .mini-player{
      position: fixed;
      left:10px; right:10px;
      bottom: calc(var(--bottomnav) + env(safe-area-inset-bottom) + 10px);
      height: var(--mini);
      z-index: 70;
      overflow:hidden;
      border-radius: 22px;

      background: rgba(24,24,27, .38);
      border: 1px solid rgba(255,255,255, var(--mini-border-alpha));

      backdrop-filter: blur(var(--mini-blur));
      -webkit-backdrop-filter: blur(var(--mini-blur));

      box-shadow:
        0 10px 24px rgba(0,0,0,.26),
        inset 0 1px 0 rgba(255,255,255,.10);
    }
    body[data-theme="light"] .mini-player{
      background: rgba(255,255,255,.55);
      border: 1px solid rgba(0,0,0,.10);
      box-shadow:
        0 10px 24px rgba(0,0,0,.12),
        inset 0 1px 0 rgba(255,255,255,.55);
    }

    .mini-topbar{
      height: 3px;
      background: rgba(255,255,255,.10);
      position:relative;
      cursor:pointer;
    }
    body[data-theme="light"] .mini-topbar{ background: rgba(0,0,0,.08); }
    .mini-topbar .fill{
      height:100%;
      width:0%;
      background: var(--accent);
      transition: width .08s linear;
    }
    .mini-topbar.loading .fill{
      width: 40%;
      animation: indet 1.05s infinite linear;
    }
    @keyframes indet{
      0%{ transform: translateX(-120%); }
      100%{ transform: translateX(320%); }
    }

    .mini-row{
      height: calc(var(--mini) - 3px);
      display:flex; align-items:center;
      gap:10px;
      padding: 10px;
    }
    .mp-left{
      display:flex; align-items:center; gap:10px;
      min-width:0; flex:1;
      cursor:pointer;
    }
    .mp-img{
      width:52px;height:52px;border-radius:16px;
      object-fit:cover;
      background: rgba(255,255,255,.10);
      flex:0 0 auto;
    }
    body[data-theme="light"] .mp-img{ background: rgba(0,0,0,.06); }
    .mp-info{min-width:0}
    .mp-title{
      font-weight:900;font-size:13px;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      text-shadow: 0 2px 10px rgba(0,0,0,.35);
    }
    .mp-artist{
      font-size:11px;color:var(--muted);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      text-shadow: 0 2px 10px rgba(0,0,0,.28);
    }

    .mp-actions{display:flex;align-items:center;gap:8px}
    .mp-btn{
      width:40px;height:40px;border-radius:16px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      color: var(--text);
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    body[data-theme="light"] .mp-btn{
      border:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.65);
      color: var(--text);
    }
    .mp-play{
      width:44px;height:44px;border-radius:18px;
      border:none;
      background: color-mix(in srgb, var(--accent) 92%, transparent);
      color:#111;
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      font-size: 14px;
      box-shadow: 0 6px 14px rgba(0,0,0,.22);
    }

    .spinner{animation: spin 1s linear infinite;}
    @keyframes spin{100%{transform:rotate(360deg)}}

    /* ===== BOTTOM NAV ===== */
    .bottom-nav{
      position: fixed; left:0; right:0; bottom:0;
      height: calc(var(--bottomnav) + env(safe-area-inset-bottom));
      padding-bottom: env(safe-area-inset-bottom);
      background: color-mix(in srgb, var(--bg) 88%, transparent);
      border-top: 1px solid var(--line);
      z-index: 60;
      display:flex; align-items:center; justify-content:center;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    .bottom-nav .inner{
      width:100%; max-width:1100px;
      height: var(--bottomnav);
      display:flex; align-items:center; justify-content:space-around;
      padding: 0 10px;
    }
    .nav-item{
      width:50%;
      height:44px;
      border-radius:18px;
      border:1px solid transparent;
      background: transparent;
      color: var(--dim);
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      gap:10px;
      font-weight:900;
    }
    .nav-item.active{
      background: color-mix(in srgb, var(--accent) 16%, transparent);
      border-color: color-mix(in srgb, var(--accent) 30%, transparent);
      color: var(--accent);
    }

    /* ===== FULL PLAYER ===== */
    .full-player{
      position: fixed; inset:0;
      z-index: 90;
      transform: translateY(100%);
      transition: transform .35s ease;
      background: color-mix(in srgb, var(--bg) 86%, transparent);
      display:flex; flex-direction:column;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .full-player.active{ transform: translateY(0); }
    .full-player.dragging{ transition:none; }

    .fp-content{
      flex:1;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding: calc(env(safe-area-inset-top) + 12px) 16px 18px;
      touch-action:none;
      position:relative;
      z-index:1;
    }

    /* ✅ transparan biar background kelihatan */
    .fp-sheet{
      max-width: 560px;
      margin:0 auto;
      background: rgba(24,24,27, var(--fp-alpha));
      border: 1px solid rgba(255,255,255, var(--fp-border-alpha));
      border-radius: 22px;
      padding: 12px 14px 16px;
      backdrop-filter: blur(var(--fp-blur));
      -webkit-backdrop-filter: blur(var(--fp-blur));
      box-shadow:
        0 14px 40px rgba(0,0,0,.26),
        inset 0 1px 0 rgba(255,255,255,.10);
    }
    body[data-theme="light"] .fp-sheet{
      background: rgba(255,255,255, var(--fp-alpha));
      border: 1px solid rgba(0,0,0, var(--fp-border-alpha));
      box-shadow:
        0 14px 40px rgba(0,0,0,.10),
        inset 0 1px 0 rgba(255,255,255,.55);
    }

    .fp-handle{
      width:44px;height:5px;border-radius:999px;
      background: color-mix(in srgb, var(--text) 22%, transparent);
      margin: 6px auto 10px;
    }

    /* ✅ header tanpa tombol kiri */
    .fp-top{
      display:flex;
      align-items:center;
      justify-content:center;
      margin-bottom: 6px;
      padding: 2px 0 6px;
      cursor: default;
    }
    .fp-now{
      color:var(--dim);
      font-size:12px;
      font-weight:900;
      letter-spacing:.9px;
      text-transform:uppercase;
    }

    .fp-cover-wrap{display:flex;justify-content:center;padding: 10px 0 10px; cursor:pointer;}
    .fp-cover{
      width: min(320px, 78vw);
      aspect-ratio:1/1;
      border-radius: 20px;
      object-fit:cover;
      background: color-mix(in srgb, var(--text) 8%, transparent);
    }

    .fp-info{
      text-align:center;
      margin: 8px 0 6px;
      cursor:pointer; /* ✅ ketuk tengah untuk tutup */
    }
    .fp-title{font-weight:900;font-size:18px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .fp-artist{font-size:12px;color:var(--muted);letter-spacing:.8px;text-transform:uppercase;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .fp-progress{
      display:flex;align-items:center;gap:10px;
      margin: 12px 0 10px;
      color: var(--dim);
      font-size:12px;
    }
    .fp-range{
      flex:1;
      -webkit-appearance:none; appearance:none;
      height:4px;border-radius:999px;
      background: color-mix(in srgb, var(--text) 14%, transparent);
      outline:none;
      cursor:pointer;
    }
    .fp-range::-webkit-slider-thumb{
      -webkit-appearance:none; appearance:none;
      width:14px;height:14px;border-radius:50%;
      background: var(--accent);
      cursor:pointer;
    }

    .fp-buttons{
      display:flex; align-items:center; justify-content:center;
      gap: 14px;
      margin-top: 6px;
    }
    .fp-btn{
      width:46px;height:46px;border-radius:18px;
      border:1px solid var(--line);
      background: color-mix(in srgb, var(--text) 7%, transparent);
      color: color-mix(in srgb, var(--text) 86%, transparent);
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      position:relative;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .fp-btn.active{
      background: color-mix(in srgb, var(--accent) 16%, transparent);
      border-color: color-mix(in srgb, var(--accent) 30%, transparent);
      color: var(--accent);
    }
    .fp-play{
      width:64px;height:64px;border-radius:22px;
      border:none; background: var(--accent); color:#111;
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      font-size: 18px;
      box-shadow: 0 12px 26px rgba(0,0,0,.22);
    }

    /* ===== MODAL ===== */
    .modal{
      position: fixed; inset:0;
      background: rgba(0,0,0,.70);
      display:none;
      align-items:center; justify-content:center;
      z-index: 120;
      padding: 16px;
    }
    body[data-theme="light"] .modal{ background: rgba(0,0,0,.45); }

    .modal-box{
      width: min(460px, 96vw);
      background: var(--surface);
      border: 1px solid var(--line);
      border-radius: 22px;
      padding: 18px 16px;
    }
    .modal-box h3{font-size:16px;font-weight:900;margin-bottom:12px}
    .input-group{margin-bottom:12px}
    .input-group label{display:block;font-size:12px;color:var(--dim);margin-bottom:6px}
    .input-group input{
      width:100%;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid var(--line);
      background: color-mix(in srgb, var(--text) 6%, transparent);
      outline:none;
      color: var(--text);
    }
    .modal-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:10px}
    .btn-cancel{
      padding:10px 14px;border-radius:16px;
      background: color-mix(in srgb, var(--text) 6%, transparent);
      border:1px solid var(--line);
      color: var(--text);
      cursor:pointer;font-weight:900;
    }

    /* Settings UI */
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin: 6px 0 12px;
    }
    .chip{
      padding:10px 12px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: color-mix(in srgb, var(--text) 6%, transparent);
      color: var(--text);
      cursor:pointer;
      font-weight:900;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .chip.active{
      background: color-mix(in srgb, var(--accent) 18%, transparent);
      border-color: color-mix(in srgb, var(--accent) 32%, transparent);
      color: var(--accent);
    }
    .danger{
      color:#ff4d6d;
      border-color: color-mix(in srgb, #ff4d6d 30%, transparent);
      background: color-mix(in srgb, #ff4d6d 10%, transparent);
    }
    .preview{
      width:100%;
      border-radius:16px;
      border:1px solid var(--line);
      overflow:hidden;
      margin-top:10px;
      background: color-mix(in srgb, var(--text) 6%, transparent);
    }
    .preview img{
      width:100%;
      display:block;
      max-height: 220px;
      object-fit:cover;
    }
    .help{
      font-size:12px;
      color: var(--dim);
      line-height:1.4;
    }
    .slider-wrap{
      display:flex;
      align-items:center;
      gap:10px;
      margin-top:10px;
    }
    .slider{
      flex:1;
      -webkit-appearance:none; appearance:none;
      height:4px;
      border-radius:999px;
      background: color-mix(in srgb, var(--text) 14%, transparent);
      outline:none;
      cursor:pointer;
    }
    .slider::-webkit-slider-thumb{
      -webkit-appearance:none; appearance:none;
      width:16px;height:16px;border-radius:50%;
      background: var(--accent);
      border: none;
    }
    .slider-val{
      width:56px;
      text-align:right;
      font-weight:900;
      color: var(--text);
      font-size:12px;
      opacity:.9;
    }

    /* ===== TOAST ===== */
    .toast{
      position: fixed;
      left:50%;
      transform: translateX(-50%) translateY(14px);
      bottom: calc(var(--bottomnav) + var(--mini) + env(safe-area-inset-bottom) + 16px);
      background: rgba(32,32,36,.72);
      border:1px solid var(--line);
      padding: 10px 14px;
      border-radius: 16px;
      opacity:0;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 130;
      pointer-events:none;
      font-size: 13px;
      max-width: min(520px, 92vw);
      text-align:center;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    body[data-theme="light"] .toast{
      background: rgba(255,255,255,.75);
    }
    .toast.show{opacity:1;transform: translateX(-50%) translateY(0)}
    .toast.success{border-left:4px solid var(--accent)}
    .toast.error{border-left:4px solid #ff4d6d}
  </style>
</head>

<body>
  <div id="bgLayer" class="bg-layer"></div>
  <div id="bgOverlay" class="bg-overlay"></div>

  <header class="appbar">
    <div class="inner">
      <div class="title">Media Player</div>
      <button class="icon-btn" onclick="openSettingsModal()" aria-label="Pengaturan">
        <i class="fas fa-gear"></i>
      </button>
    </div>
  </header>

  <!-- FULL PLAYER -->
  <div id="fullPlayer" class="full-player">
    <div class="fp-content" id="fpContent">
      <div class="fp-sheet" id="fpSheet">
        <div class="fp-handle" id="fpHandle" title="Tarik ke bawah untuk menutup"></div>

        <div class="fp-top">
          <div class="fp-now">NOW PLAYING</div>
        </div>

        <!-- ✅ ketuk tengah (cover) untuk tutup -->
        <div class="fp-cover-wrap" id="fpTapCloseArea">
          <img src="" id="fpImg" class="fp-cover" alt="cover">
        </div>

        <!-- ✅ ketuk tengah (judul/artist) untuk tutup -->
        <div class="fp-info" id="fpInfoTap">
          <div class="fp-title" id="fpTitle">Song Title</div>
          <div class="fp-artist" id="fpArtist">Artist Name</div>
        </div>

        <div class="fp-progress">
          <span id="fpCurrentTime">0:00</span>
          <input type="range" id="fpProgress" class="fp-range" value="0" min="0" max="100" step="0.1">
          <span id="fpDuration">0:00</span>
        </div>

        <div class="fp-buttons">
          <button class="fp-btn" id="fpShuffleBtn" onclick="toggleShuffle()" aria-label="Shuffle">
            <i class="fas fa-random"></i>
          </button>
          <button class="fp-btn" onclick="prevSong()" aria-label="Previous">
            <i class="fas fa-step-backward"></i>
          </button>
          <button class="fp-play" id="fpPlayBtn" onclick="togglePlay()" aria-label="Play/Pause">
            <i class="fas fa-play"></i>
          </button>
          <button class="fp-btn" onclick="nextSong()" aria-label="Next">
            <i class="fas fa-step-forward"></i>
          </button>
          <button class="fp-btn" id="fpRepeatBtn" onclick="toggleRepeat()" aria-label="Repeat">
            <i class="fas fa-redo"></i>
          </button>
        </div>

      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="toast">Pesan disini</div>

  <main>
    <div class="container">

      <div id="tab-search" class="tab-content">
        <div class="searchbox">
          <i class="fas fa-magnifying-glass"></i>
          <input type="text" id="searchInput" placeholder="Cari lagu / artist (YouTube)">
          <button class="btn-search" onclick="performSearch()" aria-label="Search">
            <i class="fas fa-arrow-right"></i>
          </button>
        </div>

        <div class="section-label">Hasil</div>

        <div id="searchResults">
          <ul class="song-list" id="searchList">
            <li class="empty-msg">Mulai dengan cari artist atau lagu.</li>
          </ul>
        </div>
      </div>

      <div id="tab-library" class="tab-content hidden">
        <div class="section-header">
          <h2>Playlist</h2>
          <button class="btn-primary" onclick="openCreateModal()">
            <i class="fas fa-plus"></i> Buat
          </button>
        </div>

        <div id="playlistGrid" class="grid"></div>

        <div id="playlistDetailView" class="hidden" style="margin-top:12px;">
          <div class="pl-detail-top">
            <button class="btn-ghost" onclick="closePlaylistDetail()">
              <i class="fas fa-arrow-left"></i> Kembali
            </button>
            <button class="btn-play-icon" onclick="playAllSongs()" aria-label="Play all">
              <i class="fas fa-play"></i>
            </button>
          </div>
          <h2 id="viewPlaylistName" style="margin: 6px 2px 12px; font-size:18px; font-weight:900;"></h2>
          <ul class="song-list" id="viewPlaylistSongs"></ul>
        </div>
      </div>

    </div>
  </main>

  <!-- MODALS -->
  <div id="createModal" class="modal">
    <div class="modal-box">
      <h3>Buat Playlist</h3>
      <div class="input-group">
        <label>Nama Playlist</label>
        <input type="text" id="newPlName" placeholder="My Playlist">
      </div>
      <div class="input-group">
        <label>Cover Image (Upload)</label>
        <input type="file" id="newPlCoverFile" accept="image/*">
        <small class="help">JPG/PNG, rekomendasi max 2MB.</small>
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="clearCreateModal()">Batal</button>
        <button class="btn-primary" onclick="savePlaylist()"><i class="fas fa-check"></i> Simpan</button>
      </div>
    </div>
  </div>

  <div id="addModal" class="modal">
    <div class="modal-box">
      <h3>Tambah ke Playlist</h3>
      <div id="addPlaylistList" style="max-height:240px; overflow-y:auto; margin: 10px 0 12px;"></div>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="closeModals()">Tutup</button>
      </div>
    </div>
  </div>

  <div id="settingsModal" class="modal">
    <div class="modal-box">
      <h3>Pengaturan</h3>

      <div class="input-group">
        <label>Tema</label>
        <div class="row">
          <button class="chip theme-chip" data-theme="dark" onclick="setTheme('dark')">
            <i class="fas fa-moon"></i> Gelap
          </button>
          <button class="chip theme-chip" data-theme="light" onclick="setTheme('light')">
            <i class="fas fa-sun"></i> Cerah
          </button>
        </div>
        <div class="help">Tema akan tersimpan otomatis.</div>
      </div>

      <div class="input-group">
        <label>Background (pakai foto sendiri)</label>
        <input type="file" id="bgFile" accept="image/*">
        <div class="help">Disarankan foto <b>≤ 6MB</b>. Akan dikompres otomatis biar ringan.</div>

        <div id="bgPreviewWrap" class="preview hidden">
          <img id="bgPreview" alt="preview background">
        </div>

        <div style="margin-top:12px;">
          <label style="display:block;font-size:12px;color:var(--dim);margin-bottom:6px;">
            Kontras Background
          </label>
          <div class="slider-wrap">
            <input id="bgContrast" class="slider" type="range" min="0.7" max="1.6" step="0.05" value="1.05">
            <div id="bgContrastVal" class="slider-val">1.05x</div>
          </div>
          <div class="help">Semakin besar, warna & detail background makin “tajam”.</div>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="chip danger" onclick="resetBackground()">
            <i class="fas fa-trash"></i> Hapus Background
          </button>
          <button class="chip" onclick="resetBgContrast()">
            <i class="fas fa-rotate-left"></i> Reset Kontras
          </button>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn-cancel" onclick="closeModals()">Tutup</button>
      </div>
    </div>
  </div>

  <!-- MINI PLAYER -->
  <footer class="mini-player" id="miniPlayer">
    <div class="mini-topbar" id="mpProgressContainer" title="Seek">
      <div class="fill" id="mpProgressFill"></div>
    </div>

    <div class="mini-row">
      <div class="mp-left" onclick="toggleFullPlayer()">
        <img src="" id="mpImg" class="mp-img" alt="cover">
        <div class="mp-info">
          <div class="mp-title" id="mpTitle">Song Title</div>
          <div class="mp-artist" id="mpArtist">Artist</div>
        </div>
      </div>

      <div class="mp-actions">
        <button class="mp-btn" onclick="prevSong()" aria-label="Prev"><i class="fas fa-backward-step"></i></button>
        <button class="mp-play" id="mpPlayBtn" onclick="togglePlay()" aria-label="Play/Pause"><i class="fas fa-play"></i></button>
        <button class="mp-btn" onclick="nextSong()" aria-label="Next"><i class="fas fa-forward-step"></i></button>
      </div>
    </div>

    <span id="mpCurrentTime" style="display:none;">0:00</span>
    <span id="mpDuration" style="display:none;">0:00</span>
  </footer>

  <!-- BOTTOM NAV -->
  <nav class="bottom-nav" aria-label="Bottom navigation">
    <div class="inner">
      <button class="nav-item active" data-tab="search" onclick="switchTab('search')">
        <i class="fas fa-magnifying-glass"></i> Search
      </button>
      <button class="nav-item" data-tab="library" onclick="switchTab('library')">
        <i class="fas fa-list-music"></i> Playlist
      </button>
    </div>
  </nav>

  <audio id="audioPlayer" preload="auto"></audio>

  <script>
    const API_SEARCH = 'https://etzy-api.vercel.app/search/youtube?q=';
    const API_PLAY   = 'https://etzy-api.vercel.app/downloader/ytplay?q=';

    let playlists = JSON.parse(localStorage.getItem('sp_playlists')) || [];
    let currentPlaylistIndex = -1;
    let searchResults = [];
    let selectedSongToAdd = null;

    let currentlyPlayingIndex = -1;
    let activeListType = 'search';

    let isPlaying = false;
    let isLoading = false;

    let isShuffle = false;
    let repeatMode = 0;

    let rafId = null;
    let lastWholeSecond = -1;

    let playReqController = null;

    const audio = document.getElementById('audioPlayer');
    const fullPlayer = document.getElementById('fullPlayer');
    const fpContent = document.getElementById('fpContent');

    const fpPlayBtn = document.getElementById('fpPlayBtn');
    const mpPlayBtn = document.getElementById('mpPlayBtn');

    const fpShuffleBtn = document.getElementById('fpShuffleBtn');
    const fpRepeatBtn = document.getElementById('fpRepeatBtn');

    const mpProgressFill = document.getElementById('mpProgressFill');
    const mpProgressContainer = document.getElementById('mpProgressContainer');
    const fpProgress = document.getElementById('fpProgress');

    const toastEl = document.getElementById('toast');
    const bgLayer = document.getElementById('bgLayer');

    const bgContrastEl = document.getElementById('bgContrast');
    const bgContrastValEl = document.getElementById('bgContrastVal');

    renderPlaylists();
    initDragClose();
    initSettings();

    // ✅ ketuk tengah (cover / info) untuk tutup full player
    document.getElementById('fpTapCloseArea').addEventListener('click', closeFullPlayer);
    document.getElementById('fpInfoTap').addEventListener('click', closeFullPlayer);

    document.getElementById('searchInput').addEventListener('keydown', (e) => {
      if(e.key === 'Enter') performSearch();
    });

    function initSettings(){
      const theme = localStorage.getItem('mp_theme') || 'dark';
      setTheme(theme, { silent: true });

      const savedContrast = parseFloat(localStorage.getItem('mp_bg_contrast') || '1.05');
      applyBgContrast(savedContrast, { silent: true });

      bgContrastEl.addEventListener('input', () => {
        const v = parseFloat(bgContrastEl.value);
        applyBgContrast(v);
      });

      const savedBg = localStorage.getItem('mp_bg') || '';
      if(savedBg) applyBackground(savedBg, { silent: true });

      document.getElementById('bgFile').addEventListener('change', async (e) => {
        const file = e.target.files && e.target.files[0];
        if(!file) return;

        if(file.size > 6 * 1024 * 1024){
          showToast("File terlalu besar (max 6MB).", "error");
          e.target.value = '';
          return;
        }

        try{
          showToast("Memproses background...", "success");
          const dataUrl = await compressImageToDataURL(file, 1280, 0.85);
          applyBackground(dataUrl);
          showToast("Background diterapkan!", "success");
        }catch(err){
          console.error(err);
          showToast("Gagal memproses background.", "error");
        }finally{
          e.target.value = '';
        }
      });
    }

    function openSettingsModal(){
      document.getElementById('settingsModal').style.display = 'flex';
    }

    function setTheme(theme, { silent=false } = {}){
      document.body.dataset.theme = theme;

      document.querySelectorAll('.theme-chip').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.theme === theme);
      });

      try{ localStorage.setItem('mp_theme', theme); } catch(e){}

      if(!silent) showToast(`Tema: ${theme === 'light' ? 'Cerah' : 'Gelap'}`, "success");
    }

    function applyBackground(dataUrl, { silent=false } = {}){
      if(!dataUrl){ resetBackground({ silent }); return; }

      bgLayer.style.backgroundImage = `url(${dataUrl})`;
      document.body.classList.add('has-bg');

      const prevWrap = document.getElementById('bgPreviewWrap');
      const prevImg = document.getElementById('bgPreview');
      prevImg.src = dataUrl;
      prevWrap.classList.remove('hidden');

      try{
        localStorage.setItem('mp_bg', dataUrl);
      }catch(e){
        resetBackground({ silent: true });
        showToast("Storage penuh. Background tidak bisa disimpan.", "error");
        return;
      }

      if(!silent) showToast("Background tersimpan.", "success");
    }

    function resetBackground({ silent=false } = {}){
      bgLayer.style.backgroundImage = '';
      document.body.classList.remove('has-bg');

      const prevWrap = document.getElementById('bgPreviewWrap');
      const prevImg = document.getElementById('bgPreview');
      prevImg.src = '';
      prevWrap.classList.add('hidden');

      try{ localStorage.removeItem('mp_bg'); }catch(e){}

      if(!silent) showToast("Background dihapus.", "success");
    }

    function applyBgContrast(value, { silent=false } = {}){
      const v = clamp(value, 0.7, 1.6);

      document.documentElement.style.setProperty('--bg-contrast', v.toFixed(2));
      bgContrastEl.value = String(v.toFixed(2));
      bgContrastValEl.textContent = `${v.toFixed(2)}x`;

      try{ localStorage.setItem('mp_bg_contrast', String(v.toFixed(2))); }catch(e){}

      if(!silent) {}
    }

    function resetBgContrast(){
      applyBgContrast(1.05);
      showToast("Kontras direset.", "success");
    }

    async function compressImageToDataURL(file, maxEdge = 1280, quality = 0.85){
      const fileDataUrl = await readFileAsDataURL(file);
      const img = await loadImage(fileDataUrl);

      let w = img.naturalWidth || img.width;
      let h = img.naturalHeight || img.height;

      const scale = Math.min(1, maxEdge / Math.max(w, h));
      w = Math.max(1, Math.round(w * scale));
      h = Math.max(1, Math.round(h * scale));

      const canvas = document.createElement('canvas');
      canvas.width = w;
      canvas.height = h;

      const ctx = canvas.getContext('2d', { alpha: false });
      ctx.drawImage(img, 0, 0, w, h);

      return canvas.toDataURL('image/jpeg', quality);
    }

    function readFileAsDataURL(file){
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    function loadImage(src){
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = src;
      });
    }

    function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

    function resetProgressUI() {
      mpProgressFill.style.width = '0%';
      fpProgress.value = 0;

      document.getElementById('fpCurrentTime').innerText = '0:00';
      document.getElementById('fpDuration').innerText = '0:00';

      document.getElementById('mpCurrentTime').innerText = '0:00';
      document.getElementById('mpDuration').innerText = '0:00';
    }

    function setLoading(state){
      isLoading = state;
      mpProgressContainer.classList.toggle('loading', state);

      const iconHtml = state
        ? '<i class="fas fa-spinner spinner"></i>'
        : `<i class="fas ${isPlaying ? 'fa-pause' : 'fa-play'}"></i>`;

      fpPlayBtn.innerHTML = iconHtml;
      mpPlayBtn.innerHTML = iconHtml;

      document.querySelectorAll('.mp-btn, .fp-btn, .fp-play, .mp-play')
        .forEach(btn => btn.disabled = state);
    }

    function setPlaying(state){
      isPlaying = state;
      if(isLoading) return;
      const icon = isPlaying ? 'fa-pause' : 'fa-play';
      fpPlayBtn.innerHTML = `<i class="fas ${icon}"></i>`;
      mpPlayBtn.innerHTML = `<i class="fas ${icon}"></i>`;
    }

    function startProgressLoop(){
      if(rafId) cancelAnimationFrame(rafId);
      const tick = () => {
        if(audio.duration && !isNaN(audio.duration)){
          const pct = (audio.currentTime / audio.duration) * 100;
          mpProgressFill.style.width = `${pct}%`;
          fpProgress.value = pct;

          const whole = Math.floor(audio.currentTime);
          if(whole !== lastWholeSecond){
            lastWholeSecond = whole;
            document.getElementById('fpCurrentTime').innerText = formatTime(audio.currentTime);
            document.getElementById('fpDuration').innerText = formatTime(audio.duration);
          }
        }
        rafId = requestAnimationFrame(tick);
      };
      tick();
    }

    function stopProgressLoop(){
      if(rafId) cancelAnimationFrame(rafId);
      rafId = null;
      lastWholeSecond = -1;
    }

    function stopCurrentNow({ showLoading = true } = {}) {
      if (playReqController) {
        try { playReqController.abort(); } catch(_) {}
        playReqController = null;
      }

      audio.pause();
      audio.currentTime = 0;
      audio.removeAttribute('src');
      audio.load();

      stopProgressLoop();
      resetProgressUI();

      setPlaying(false);
      if (showLoading) setLoading(true);
      else setLoading(false);
    }

    audio.addEventListener('loadstart', () => setLoading(true));
    audio.addEventListener('waiting',   () => setLoading(true));
    audio.addEventListener('canplay',   () => setLoading(false));
    audio.addEventListener('playing',   () => { setLoading(false); setPlaying(true); startProgressLoop(); });
    audio.addEventListener('pause',     () => { setPlaying(false); stopProgressLoop(); });
    audio.addEventListener('ended',     () => { stopProgressLoop(); nextSong(); });

    audio.addEventListener('error', () => {
      setLoading(false);
      setPlaying(false);
      stopProgressLoop();
      resetProgressUI();
      nextSong();
    });

    mpProgressContainer.addEventListener('click', (e) => {
      if(!audio.duration) return;
      const rect = mpProgressContainer.getBoundingClientRect();
      const pct = (e.clientX - rect.left) / rect.width;
      audio.currentTime = pct * audio.duration;
    });

    fpProgress.addEventListener('input', (e) => {
      if(!audio.duration) return;
      const time = (e.target.value / 100) * audio.duration;
      audio.currentTime = time;
    });

    // ✅ drag down to close (tanpa tombol)
    function initDragClose() {
      let startY = 0, currentY = 0, dragging = false;

      fpContent.addEventListener('mousedown', startDrag);
      fpContent.addEventListener('touchstart', startDrag, {passive:true});
      document.addEventListener('mousemove', drag);
      document.addEventListener('touchmove', drag, {passive:true});
      document.addEventListener('mouseup', endDrag);
      document.addEventListener('touchend', endDrag);

      function startDrag(e) {
        if(!fullPlayer.classList.contains('active')) return;
        dragging = true;
        startY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
        fullPlayer.classList.add('dragging');
      }
      function drag(e) {
        if(!dragging) return;
        currentY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
        const delta = currentY - startY;
        if(delta > 0) fullPlayer.style.transform = `translateY(${Math.min(delta, innerHeight)}px)`;
      }
      function endDrag() {
        if(!dragging) return;
        dragging = false;
        fullPlayer.classList.remove('dragging');
        const delta = currentY - startY;
        if(delta > 140) closeFullPlayer();
        else fullPlayer.style.transform = 'translateY(0)';
      }
    }

    function closeFullPlayer(){
      fullPlayer.classList.remove('active');
      fullPlayer.style.transform = '';
    }

    function toggleFullPlayer(){
      if(fullPlayer.classList.contains('active')) closeFullPlayer();
      else { fullPlayer.classList.add('active'); fullPlayer.style.transform='translateY(0)'; }
    }

    async function performSearch(){
      const query = document.getElementById('searchInput').value.trim();
      if(!query) return;

      const list = document.getElementById('searchList');
      list.innerHTML = `<li class="empty-msg"><i class="fas fa-spinner spinner"></i> Searching...</li>`;

      try{
        const res = await fetch(API_SEARCH + encodeURIComponent(query));
        if(!res.ok) throw new Error("API Error");
        const data = await res.json();

        let songs = [];
        if(Array.isArray(data)) songs = data;
        else if(data.result && Array.isArray(data.result)) songs = data.result;

        if(!songs.length){
          list.innerHTML = `<li class="empty-msg">No results found.</li>`;
          return;
        }

        searchResults = songs.slice(0, 20);
        activeListType = 'search';

        list.innerHTML = '';
        const frag = document.createDocumentFragment();

        searchResults.forEach((song, idx) => {
          const li = document.createElement('li');
          li.className = 'song-item';

          if(idx === currentlyPlayingIndex && activeListType === 'search') li.classList.add('active-selection');

          const imgUrl = song.image || song.thumbnail || song.imageUrl || `https://picsum.photos/seed/${idx}/200`;

          li.innerHTML = `
            <img src="${imgUrl}" onerror="this.src='https://picsum.photos/200'">
            <div class="song-info">
              <div class="song-title">${song.title || 'Unknown'}</div>
              <div class="song-artist">${song.channel || song.author || 'Unknown'}</div>
            </div>
            <button class="action-btn btn-add">Add</button>
          `;

          li.querySelector('.btn-add').onclick = (e) => openAddModal(idx, e);
          li.onclick = (e) => {
            if(e.target.classList.contains('btn-add')) return;
            playSongAtIndex(idx, 'search');
          };

          frag.appendChild(li);
        });

        list.appendChild(frag);
      }catch(err){
        console.error(err);
        list.innerHTML = `<li class="empty-msg">Connection Error. Try again.</li>`;
      }
    }

    function savePlaylist(){
      const name = document.getElementById('newPlName').value.trim();
      const fileInput = document.getElementById('newPlCoverFile');
      if(!name) return;

      let coverBase64 = "https://picsum.photos/seed/" + Date.now() + "/500";

      if(fileInput.files && fileInput.files[0]){
        const file = fileInput.files[0];
        if(file.size > 2 * 1024 * 1024) return showToast("File terlalu besar (Max 2MB).","error");
        const reader = new FileReader();
        reader.onload = (e) => finalizePlaylist(name, e.target.result);
        reader.readAsDataURL(file);
      }else{
        finalizePlaylist(name, coverBase64);
      }
    }

    function finalizePlaylist(name, cover){
      playlists.push({ id: Date.now(), name, cover, songs: [] });
      try{
        localStorage.setItem('sp_playlists', JSON.stringify(playlists));
        renderPlaylists();
        clearCreateModal();
        showToast("Playlist dibuat!","success");
      }catch(e){
        showToast("Storage penuh.","error");
      }
    }

    function clearCreateModal(){
      document.getElementById('newPlName').value='';
      document.getElementById('newPlCoverFile').value='';
      closeModals();
    }

    function renderPlaylists(){
      const grid = document.getElementById('playlistGrid');
      grid.innerHTML = '';

      if(!playlists.length){
        grid.innerHTML = `<div class="empty-msg" style="grid-column:1/-1;">Belum ada playlist. Buat dulu ya.</div>`;
        return;
      }

      const frag = document.createDocumentFragment();

      playlists.forEach((pl, idx) => {
        const div = document.createElement('div');
        div.className = 'playlist-card';
        div.onclick = () => openPlaylistDetail(idx);

        div.innerHTML = `
          <button class="delete-btn" aria-label="Delete"><i class="fas fa-trash"></i></button>
          <div class="cover-art"><img src="${pl.cover}" onerror="this.src='https://picsum.photos/500'"></div>
          <div class="playlist-name">${pl.name}</div>
          <div class="playlist-desc">${pl.songs.length} songs</div>
        `;
        div.querySelector('.delete-btn').onclick = (e) => deletePlaylist(e, pl.id);

        frag.appendChild(div);
      });

      grid.appendChild(frag);
    }

    function openPlaylistDetail(idx){
      currentPlaylistIndex = idx;
      const pl = playlists[idx];

      document.getElementById('playlistGrid').classList.add('hidden');
      document.querySelector('.section-header').classList.add('hidden');

      document.getElementById('playlistDetailView').classList.remove('hidden');
      document.getElementById('viewPlaylistName').innerText = pl.name;
      renderPlaylistSongs();
    }

    function closePlaylistDetail(){
      document.getElementById('playlistGrid').classList.remove('hidden');
      document.querySelector('.section-header').classList.remove('hidden');
      document.getElementById('playlistDetailView').classList.add('hidden');
      currentPlaylistIndex = -1;
    }

    function renderPlaylistSongs(){
      const pl = playlists[currentPlaylistIndex];
      const list = document.getElementById('viewPlaylistSongs');
      list.innerHTML = '';
      activeListType = 'playlist';

      if(!pl.songs.length){
        list.innerHTML = `<li class="empty-msg">Playlist kosong. Tambah lagu dari Search.</li>`;
        return;
      }

      const frag = document.createDocumentFragment();

      pl.songs.forEach((song, idx) => {
        const li = document.createElement('li');
        li.className='song-item';

        if(idx === currentlyPlayingIndex && activeListType === 'playlist') li.classList.add('active-selection');

        const imgUrl = song.image || getUniqueCover(song.title);

        li.innerHTML = `
          <img src="${imgUrl}" onerror="this.src='https://picsum.photos/200'">
          <div class="song-info">
            <div class="song-title">${song.title || 'Unknown'}</div>
            <div class="song-artist">${song.channel || song.author || 'Unknown'}</div>
          </div>
          <button class="action-btn btn-remove" aria-label="Remove"><i class="fas fa-trash"></i></button>
        `;

        li.querySelector('.btn-remove').onclick = (e) => removeSong(idx, e);
        li.onclick = (e) => {
          if(e.target.closest('.btn-remove')) return;
          playSongAtIndex(idx, 'playlist');
        };

        frag.appendChild(li);
      });

      list.appendChild(frag);
    }

    function playAllSongs(){
      if(currentPlaylistIndex === -1) return;
      const pl = playlists[currentPlaylistIndex];
      if(!pl.songs.length) return showToast("Playlist kosong","error");
      activeListType = 'playlist';
      playSongAtIndex(0, 'playlist');
    }

    function removeSong(idx, e){
      if(e) e.stopPropagation();
      playlists[currentPlaylistIndex].songs.splice(idx, 1);
      localStorage.setItem('sp_playlists', JSON.stringify(playlists));
      renderPlaylistSongs();
      renderPlaylists();
    }

    function deletePlaylist(e, id){
      if(e) e.stopPropagation();
      if(confirm("Hapus playlist ini?")){
        playlists = playlists.filter(p => p.id !== id);
        localStorage.setItem('sp_playlists', JSON.stringify(playlists));
        renderPlaylists();
        if(currentPlaylistIndex !== -1) closePlaylistDetail();
      }
    }

    function openAddModal(searchIdx, e){
      if(e) e.stopPropagation();
      if(!playlists.length) return showToast("Buat playlist dulu.","error");

      selectedSongToAdd = searchResults[searchIdx];
      const listDiv = document.getElementById('addPlaylistList');
      listDiv.innerHTML = '';

      playlists.forEach(pl => {
        const item = document.createElement('div');
        item.style.cssText = `
          padding:12px;
          background: color-mix(in srgb, var(--text) 6%, transparent);
          border: 1px solid var(--line);
          margin-bottom:8px;
          border-radius:16px;
          cursor:pointer;
          font-weight:900;
        `;
        item.innerText = pl.name;

        item.onclick = () => {
          if(!pl.songs.some(s => s.link === selectedSongToAdd.link)){
            pl.songs.push(selectedSongToAdd);
            localStorage.setItem('sp_playlists', JSON.stringify(playlists));
            renderPlaylists();
            if(currentPlaylistIndex !== -1 && playlists[currentPlaylistIndex].id === pl.id) renderPlaylistSongs();
            showToast(`Ditambahkan ke ${pl.name}`,"success");
            closeModals();
          }else{
            showToast("Sudah ada di playlist","error");
          }
        };

        listDiv.appendChild(item);
      });

      document.getElementById('addModal').style.display='flex';
    }

    function playSongAtIndex(idx, type){
      currentlyPlayingIndex = idx;
      activeListType = type;

      let song = null;
      if(type === 'search') song = searchResults[idx];
      else if(type === 'playlist') song = playlists[currentPlaylistIndex].songs[idx];
      if(!song) return;

      document.querySelectorAll('.song-item').forEach(el => el.classList.remove('active-selection'));
      if(type === 'search'){
        const items = document.querySelectorAll('#searchList .song-item');
        if(items[idx]) items[idx].classList.add('active-selection');
      }else{
        const items = document.querySelectorAll('#viewPlaylistSongs .song-item');
        if(items[idx]) items[idx].classList.add('active-selection');
      }

      // ✅ stop dulu, reset detik jadi 0, baru load lagu berikutnya
      stopCurrentNow({ showLoading: true });
      loadAndPlay(song);
    }

    async function loadAndPlay(song){
      updatePlayerUI(song);
      setLoading(true);

      playReqController = new AbortController();
      const { signal } = playReqController;

      try{
        const res = await fetch(API_PLAY + encodeURIComponent(song.link), { signal });
        const data = await res.json();

        if (signal.aborted) return;

        if(data.success && data.result?.downloadUrl){
          audio.src = data.result.downloadUrl;

          if(data.result.metadata){
            song.title = data.result.metadata.title;
            song.channel = data.result.metadata.author;
            if(data.result.metadata.thumbnail) song.image = data.result.metadata.thumbnail;

            if(activeListType === 'playlist'){
              playlists[currentPlaylistIndex].songs[currentlyPlayingIndex] = song;
              savePlaylistsToStorage();
            }
          }

          updatePlayerUI(song);

          const p = audio.play();
          if(p) p.catch(() => {
            setLoading(false);
            setPlaying(false);
            showToast("Autoplay diblokir. Tap Play.","error");
          });

        }else{
          throw new Error("Stream failed");
        }
      }catch(err){
        if (err?.name === 'AbortError') return;

        console.error(err);
        setLoading(false);
        setPlaying(false);

        if(activeListType === 'playlist'){
          showToast("Link expired. Refreshing...","error");
          await refreshSongLink(song);
        }else{
          showToast("Stream gagal.","error");
        }
      }finally{
        if (playReqController && playReqController.signal === signal) {
          playReqController = null;
        }
      }
    }

    async function refreshSongLink(song){
      try{
        const searchRes = await fetch(API_SEARCH + encodeURIComponent(song.title));
        const searchData = await searchRes.json();
        let freshSongs = Array.isArray(searchData) ? searchData : (searchData.result || []);

        const found = freshSongs.find(s => s.title === song.title && s.channel === song.channel);
        if(!found) throw new Error("Not found");

        playlists[currentPlaylistIndex].songs[currentlyPlayingIndex] = found;
        savePlaylistsToStorage();

        stopCurrentNow({ showLoading: true });

        playReqController = new AbortController();
        const { signal } = playReqController;

        const playRes = await fetch(API_PLAY + encodeURIComponent(found.link), { signal });
        const playData = await playRes.json();

        if (signal.aborted) return;

        if(playData.success && playData.result?.downloadUrl){
          audio.src = playData.result.downloadUrl;
          updatePlayerUI(found);
          audio.play();
          showToast("Link diperbarui","success");
        }else{
          throw new Error("Refresh play failed");
        }
      }catch(e){
        if (e?.name === 'AbortError') return;
        console.error(e);
        setLoading(false);
        setPlaying(false);
        showToast("Tidak bisa memutar lagu ini sekarang.","error");
      }finally{
        playReqController = null;
      }
    }

    function updatePlayerUI(song){
      const imgUrl = song.image || getUniqueCover(song.title || 'unknown');
      document.getElementById('mpImg').src = imgUrl;
      document.getElementById('mpTitle').innerText = song.title || 'Unknown';
      document.getElementById('mpArtist').innerText = song.channel || song.author || 'Unknown';

      document.getElementById('fpImg').src = imgUrl;
      document.getElementById('fpTitle').innerText = song.title || 'Unknown';
      document.getElementById('fpArtist').innerText = (song.channel || song.author || 'Unknown');
    }

    function togglePlay(){
      if(isLoading) return;
      if(!audio.src){
        if(currentlyPlayingIndex === -1) return showToast("Pilih lagu dulu.","error");
      }
      if(audio.paused) audio.play();
      else audio.pause();
    }

    function toggleShuffle(){
      isShuffle = !isShuffle;
      fpShuffleBtn.classList.toggle('active', isShuffle);
    }

    function toggleRepeat(){
      repeatMode = (repeatMode + 1) % 3;
      fpRepeatBtn.classList.toggle('active', repeatMode !== 0);

      if(repeatMode === 2){
        fpRepeatBtn.innerHTML = '<i class="fas fa-redo"></i><span style="font-size:10px; position:absolute; bottom:6px; right:10px;">1</span>';
      }else{
        fpRepeatBtn.innerHTML = '<i class="fas fa-redo"></i>';
      }
    }

    function nextSong(){
      if(repeatMode === 2){
        playSongAtIndex(currentlyPlayingIndex, activeListType);
        return;
      }

      let len = 0;
      if(activeListType === 'search') len = searchResults.length;
      else if(activeListType === 'playlist') len = playlists[currentPlaylistIndex]?.songs?.length || 0;
      if(!len) return;

      let nextIdx = currentlyPlayingIndex + 1;

      if(isShuffle){
        nextIdx = Math.floor(Math.random() * len);
      }else{
        if(nextIdx >= len){
          if(repeatMode === 1) nextIdx = 0;
          else return;
        }
      }
      playSongAtIndex(nextIdx, activeListType);
    }

    function prevSong(){
      let len = 0;
      if(activeListType === 'search') len = searchResults.length;
      else if(activeListType === 'playlist') len = playlists[currentPlaylistIndex]?.songs?.length || 0;
      if(!len) return;

      let prevIdx = currentlyPlayingIndex - 1;
      if(prevIdx < 0) prevIdx = len - 1;
      playSongAtIndex(prevIdx, activeListType);
    }

    function savePlaylistsToStorage(){
      try{ localStorage.setItem('sp_playlists', JSON.stringify(playlists)); }
      catch(e){ console.error(e); }
    }

    function switchTab(t){
      document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));

      document.getElementById(`tab-${t}`).classList.remove('hidden');
      const btn = document.querySelector(`.nav-item[data-tab="${t}"]`);
      if(btn) btn.classList.add('active');
    }

    function openCreateModal(){ document.getElementById('createModal').style.display='flex'; }
    function closeModals(){ document.querySelectorAll('.modal').forEach(m => m.style.display='none'); }

    function showToast(msg, type='success'){
      toastEl.innerText = msg;
      toastEl.className = `toast ${type} show`;
      setTimeout(() => toastEl.classList.remove('show'), 2600);
    }

    function formatTime(s){
      if(isNaN(s)) return "0:00";
      const m = Math.floor(s / 60);
      const sec = Math.floor(s % 60);
      return `${m}:${sec < 10 ? '0' : ''}${sec}`;
    }

    function getUniqueCover(title){
      let hash = 0;
      const str = String(title || 'unknown');
      for(let i=0;i<str.length;i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
      return `https://picsum.photos/seed/${Math.abs(hash)}/500`;
    }
  </script>
</body>
</html>
